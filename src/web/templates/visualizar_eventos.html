<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Visualizar Eventos</title>
    <meta property="og:title" content="Visualizar Eventos" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/principal.css') }}" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/697919b5b5.js" crossorigin="anonymous"></script>

    <style>
      body {
        background-image: url('{{ url_for('static', filename='images/Fondo.png') }}');
        background-size: cover;
        background-attachment: fixed;
      }

      .main-container {
        padding: 20px;
        margin-top: 20px;
        margin-bottom: 40px;
      }

      .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.98);
      }

      .card-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 20px;
      }

      .card-header h3 {
        margin: 0;
        font-weight: 600;
      }

      .table-container {
        padding: 20px;
      }

      .btn-action {
        padding: 5px 10px;
        font-size: 0.875rem;
        margin: 2px;
      }

      .badge-custom {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      /* DataTables custom styling */
      .dataTables_wrapper .dataTables_filter input {
        border: 1px solid #ced4da;
        border-radius: 5px;
        padding: 5px 10px;
      }

      .dataTables_wrapper .dataTables_length select {
        border: 1px solid #ced4da;
        border-radius: 5px;
        padding: 5px;
      }

      table.dataTable thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
      }

      table.dataTable tbody tr:hover {
        background-color: #f0f0f0;
      }

      .status-badge {
        display: inline-block;
        min-width: 80px;
      }

      /* Loading overlay */
      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
      }

      /* Stats cards */
      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .stats-card .stats-icon {
        font-size: 2rem;
        opacity: 0.7;
      }

      .stats-card .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin: 10px 0;
      }

      .stats-card .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
      }
    </style>
  </head>

  <body>
    <!-- Header Mejorado -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div class="container-fluid px-4">
        <!-- Logo -->
        <a class="navbar-brand d-flex align-items-center" href="/Perfil" style="cursor: pointer;">
          <img
            alt="Logo RuptureLakes"
            src="{{ url_for('static', filename='images/logos/RL_logo.png') }}"
            height="40"
            class="me-2"
          />
          <span class="fw-bold">RuptureLakes</span>
        </a>

        <!-- Toggle para móvil -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menú de navegación -->
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <!-- Botón Lobby -->
            <li class="nav-item">
              <a class="nav-link btn btn-outline-light me-2" href="/Perfil" style="border-radius: 20px; padding: 8px 20px;">
                <i class="fas fa-home"></i> Inicio
              </a>
            </li>

            <!-- Usuario -->
            <li class="nav-item dropdown me-2">
              <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle fa-lg"></i>
                <span id="navbarUsername" class="ms-1"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/Perfil"><i class="fas fa-home"></i> Ir al Inicio</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="/Inicio"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
              </ul>
            </li>

            <!-- Botón Cerrar Sesión (visible siempre) -->
            <li class="nav-item">
              <a class="btn btn-danger" href="/Inicio" style="border-radius: 20px; padding: 8px 20px;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Espaciador para el navbar fixed -->
    <div style="height: 70px;"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <!-- Main Container -->
    <div class="container-fluid main-container">
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card text-center">
            <i class="fas fa-clipboard-list stats-icon text-primary"></i>
            <div class="stats-number text-primary" id="totalEventos">{{ events|length }}</div>
            <div class="stats-label">Total de Eventos</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <i class="fas fa-check-circle stats-icon text-success"></i>
            <div class="stats-number text-success" id="eventosAprobados">0</div>
            <div class="stats-label">Aprobados</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <i class="fas fa-clock stats-icon text-warning"></i>
            <div class="stats-number text-warning" id="eventosPendientes">0</div>
            <div class="stats-label">Pendientes</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <i class="fas fa-tint stats-icon text-info"></i>
            <div class="stats-number text-info" id="volumenTotal">0</div>
            <div class="stats-label">Volumen Total (m³)</div>
          </div>
        </div>
      </div>

      <!-- Table Card -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h3><i class="fas fa-table"></i> Todos los Eventos</h3>
                <div>
                  <button id="eliminarRangoBoton" type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#modalEliminarRango">
                    <i class="fas fa-trash-alt"></i> Eliminar Rango
                  </button>
                  <form method="POST" action="Descargar" style="display: inline-block;">
                    <button id="descargarBoton" type="submit" class="btn btn-success me-2">
                      <i class="fas fa-download"></i> Descargar eventos
                    </button>
                  </form>
                  <a href="/BuscarEvento" class="btn btn-light me-2">
                    <i class="fas fa-search"></i> Búsqueda Individual
                  </a>
                  <a href="/Perfil" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Volver
                  </a>
                </div>
              </div>
            </div>
            <div class="card-body table-container">
              <div class="table-responsive">
                <table id="eventosTable" class="table table-striped table-hover" style="width:100%">
                  <thead>
                    <tr>
                      <th>Orden</th>
                      <th>Fecha Inicio</th>
                      <th>Ubicación</th>
                      <th>Volumen (m³)</th>
                      <th>Flujo (m³/h)</th>
                      <th>Presión (psig)</th>
                      <th>Duración (hrs)</th>
                      <th>Forma</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for event in events %}
                    <tr data-orden="{{ event.orden }}">
                      <td><strong>{{ event.orden }}</strong></td>
                      <td>{{ event.inicio }}</td>
                      <td><small>{{ event.ubicacion }}</small></td>
                      <td>{{ event.volumen }}</td>
                      <td>{{ event.flujo }}</td>
                      <td>{{ event.presion }}</td>
                      <td>{{ event.duracion_hrs }}</td>
                      <td>
                        <span class="badge bg-info">{{ event.forma }}</span>
                      </td>
                      <td>
                        {% if event.aprobado == 'sí' or event.aprobado == 'si' %}
                          <span class="badge bg-success status-badge">
                            <i class="fas fa-check"></i> Aprobado
                          </span>
                        {% else %}
                          <span class="badge bg-warning text-dark status-badge">
                            <i class="fas fa-clock"></i> Pendiente
                          </span>
                        {% endif %}
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <!-- Botón Ver (todos pueden ver) -->
                          <button type="button" class="btn btn-sm btn-primary btn-action" onclick="verEvento('{{ event.orden }}')">
                            <i class="fas fa-eye"></i> Ver
                          </button>

                          <!-- Botón Editar (solo SuperAdmin) -->
                          {% if user_rol == 'SuperAdmin' %}
                          <button type="button" class="btn btn-sm btn-warning btn-action" onclick="editarEvento('{{ event.orden }}')">
                            <i class="fas fa-edit"></i> Editar
                          </button>
                          {% endif %}

                          <!-- Botón Eliminar (solo SuperAdmin) -->
                          {% if user_rol == 'SuperAdmin' %}
                          <button type="button" class="btn btn-sm btn-danger btn-action" onclick="confirmarEliminar('{{ event.orden }}')">
                            <i class="fas fa-trash"></i> Eliminar
                          </button>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>¿Estás seguro de que deseas eliminar el evento <strong id="ordenEliminar"></strong>?</p>
            <p class="text-danger"><i class="fas fa-info-circle"></i> Esta acción no se puede deshacer.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="eliminarEvento()">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Eliminar Rango -->
    <div class="modal fade" id="modalEliminarRango" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-trash-alt"></i> Eliminar Rango de Eventos
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Advertencia:</strong> Esta acción eliminará TODOS los eventos en el rango especificado y no se puede deshacer.
            </div>
            <form id="formEliminarRango">
              <div class="mb-3">
                <label for="ordenDesde" class="form-label">Desde Número de Orden:</label>
                <input type="text" class="form-control" id="ordenDesde" placeholder="Ej: EV-001" required>
                <small class="text-muted">Número de orden inicial del rango</small>
              </div>
              <div class="mb-3">
                <label for="ordenHasta" class="form-label">Hasta Número de Orden:</label>
                <input type="text" class="form-control" id="ordenHasta" placeholder="Ej: EV-010" required>
                <small class="text-muted">Número de orden final del rango (inclusive)</small>
              </div>
              <div id="previewRango" class="alert alert-info" style="display: none;">
                <strong>Vista previa:</strong> Se eliminarán <span id="cantidadEventos">0</span> eventos.
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="eliminarRangoEventos()">
              <i class="fas fa-trash-alt"></i> Eliminar Rango
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
      let tabla;
      let ordenAEliminar = '';

      // Inicializar DataTable
      $(document).ready(function() {
        tabla = $('#eventosTable').DataTable({
          responsive: true,
          language: {
            url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
          },
          order: [[1, 'desc']], // Ordenar por fecha de inicio (más reciente primero)
          pageLength: 25,
          lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
          dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
               '<"row"<"col-sm-12"tr>>' +
               '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          drawCallback: function() {
            // Actualizar estadísticas cuando cambie la tabla
            actualizarEstadisticas();
          }
        });

        // Calcular estadísticas iniciales
        actualizarEstadisticas();
      });

      function actualizarEstadisticas() {
        let aprobados = 0;
        let pendientes = 0;
        let volumenTotal = 0;
        let totalEventos = 0;

        // Recorrer todas las filas VISIBLES de la tabla (después de filtros/eliminaciones)
        tabla.rows({ search: 'applied' }).every(function() {
          var row = this.node();
          totalEventos++;

          // Verificar si tiene badge de aprobado
          var estadoBadge = $(row).find('.status-badge');
          if (estadoBadge.text().includes('Aprobado')) {
            aprobados++;
          } else {
            pendientes++;
          }

          // Sumar volumen (columna 3, índice 3)
          var volumen = parseFloat($(row).find('td').eq(3).text()) || 0;
          volumenTotal += volumen;
        });

        document.getElementById('totalEventos').textContent = totalEventos;
        document.getElementById('eventosAprobados').textContent = aprobados;
        document.getElementById('eventosPendientes').textContent = pendientes;
        document.getElementById('volumenTotal').textContent = volumenTotal.toFixed(2);
      }

      function verEvento(orden) {
        // Guardar orden en cookie y redirigir al reporte
        document.cookie = `orden=${orden}; path=/`;

        // Crear formulario temporal para POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/Reporte';
        document.body.appendChild(form);
        form.submit();
      }

      function editarEvento(orden) {
        // Guardar orden en cookie y redirigir a editar
        document.cookie = `orden=${orden}; path=/`;

        // Crear formulario temporal para POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/Editar';
        document.body.appendChild(form);
        form.submit();
      }

      function confirmarEliminar(orden) {
        ordenAEliminar = orden;
        document.getElementById('ordenEliminar').textContent = orden;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
      }

      function eliminarEvento() {
        if (!ordenAEliminar) return;

        // Mostrar loading
        document.getElementById('loadingOverlay').classList.add('active');

        fetch('/rupture/deleteEvent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ orden: ordenAEliminar })
        })
        .then(response => response.json())
        .then(data => {
          // Ocultar loading
          document.getElementById('loadingOverlay').classList.remove('active');

          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
          if (modal) {
            modal.hide();
          }

          if (data.success) {
            console.log(`Eliminando evento con orden: ${ordenAEliminar}`);

            // Buscar y remover la fila de la tabla usando DataTables API
            var filaAEliminar = tabla.row(function(idx, data, node) {
              return $(node).attr('data-orden') === ordenAEliminar;
            });

            if (filaAEliminar.length > 0) {
              filaAEliminar.remove().draw(false);
              console.log('Fila eliminada de la tabla');

              // Actualizar estadísticas después de eliminar
              setTimeout(function() {
                actualizarEstadisticas();
              }, 100);

              // Mostrar mensaje de éxito
              alert('✓ Evento eliminado exitosamente');
            } else {
              console.error('No se encontró la fila con data-orden:', ordenAEliminar);
              alert('✓ Evento eliminado exitosamente. Recargando página...');
              location.reload();
            }
          } else {
            alert('✗ Error al eliminar el evento: ' + (data.error || 'Error desconocido'));
          }
        })
        .catch(error => {
          document.getElementById('loadingOverlay').classList.remove('active');
          console.error('Error:', error);
          alert('✗ Error al eliminar el evento. Intenta de nuevo.');
        });

        ordenAEliminar = '';
      }

      // Cookie helper
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Mostrar nombre de usuario en navbar
      function mostrarUsuarioNavbar() {
        const nombre = getCookie('nombre1');
        const apellido = getCookie('nombre2');
        if (nombre) {
          const nombreCompleto = apellido ? `${nombre} ${apellido}` : nombre;
          document.getElementById('navbarUsername').textContent = nombreCompleto;
        }
      }

      // Ocultar botones si no es SuperAdmin
      function ocultarBotonesSuperAdmin() {
        const rol = getCookie('rol');
        if (rol !== 'SuperAdmin') {
          const btnDescargar = document.getElementById('descargarBoton');
          if (btnDescargar) {
            btnDescargar.style.display = 'none';
          }
          const btnEliminarRango = document.getElementById('eliminarRangoBoton');
          if (btnEliminarRango) {
            btnEliminarRango.style.display = 'none';
          }
        }
      }

      // Función para eliminar rango de eventos
      function eliminarRangoEventos() {
        const ordenDesde = document.getElementById('ordenDesde').value.trim();
        const ordenHasta = document.getElementById('ordenHasta').value.trim();

        if (!ordenDesde || !ordenHasta) {
          alert('Por favor ingresa ambos números de orden');
          return;
        }

        if (!confirm(`¿Estás seguro de eliminar todos los eventos desde "${ordenDesde}" hasta "${ordenHasta}"?\n\nEsta acción no se puede deshacer.`)) {
          return;
        }

        // Mostrar overlay de carga
        document.getElementById('loadingOverlay').classList.add('active');

        // Llamar al backend para eliminar el rango
        fetch('/rupture/deleteEventRange', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orden_desde: ordenDesde,
            orden_hasta: ordenHasta
          })
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('loadingOverlay').classList.remove('active');

          if (data.success) {
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarRango'));
            modal.hide();

            // Limpiar campos
            document.getElementById('ordenDesde').value = '';
            document.getElementById('ordenHasta').value = '';

            alert(`✓ Se eliminaron exitosamente ${data.deleted_count} eventos`);

            // Recargar la página para actualizar la tabla
            location.reload();
          } else {
            alert(`✗ Error: ${data.message || 'No se pudo eliminar el rango'}`);
          }
        })
        .catch(error => {
          document.getElementById('loadingOverlay').classList.remove('active');
          console.error('Error:', error);
          alert('✗ Error al eliminar el rango de eventos. Intenta de nuevo.');
        });
      }

      // Ejecutar al cargar
      mostrarUsuarioNavbar();
      ocultarBotonesSuperAdmin();
    </script>
  </body>
</html>
